{% extends "base.html" %}
{% block title %}Jelly Roll{% endblock %}

{% block content %}
<div class="container py-3">
  <h3 class="mb-3">Jelly Roll（Time-Box）＝ (C−P)@T1 − (C−P)@T2</h3>

  <!-- 入力フォーム -->
  <form method="post" class="row g-3">
    <div class="col-md-2"><label class="form-label">S0 (USD/JPY)</label><input name="S0" class="form-control" type="number" step="0.1" value="{{ S0 }}"></div>
    <div class="col-md-2"><label class="form-label">K</label><input name="K" class="form-control" type="number" step="0.1" value="{{ K }}"></div>

    <div class="col-md-2"><label class="form-label">T1 (月)</label><input name="months1" class="form-control" type="number" step="0.1" value="{{ months1 }}"></div>
    <div class="col-md-2"><label class="form-label">T2 (月)</label><input name="months2" class="form-control" type="number" step="0.1" value="{{ months2 }}"></div>

    <div class="col-md-2"><label class="form-label">Vol (%/年)</label><input name="vol" class="form-control" type="number" step="0.1" value="{{ vol }}"></div>
    <div class="col-md-2"><label class="form-label">r_dom JPY (%/年)</label><input name="r_dom" class="form-control" type="number" step="0.1" value="{{ r_dom }}"></div>
    <div class="col-md-2"><label class="form-label">r_for USD (%/年)</label><input name="r_for" class="form-control" type="number" step="0.1" value="{{ r_for }}"></div>

    <div class="col-md-2"><label class="form-label">数量 (USD)</label><input name="qty" class="form-control" type="number" step="1" value="{{ qty }}"></div>

    <div class="col-md-2"><label class="form-label">S最小</label><input name="smin" class="form-control" type="number" step="0.1" value="{{ smin }}"></div>
    <div class="col-md-2"><label class="form-label">S最大</label><input name="smax" class="form-control" type="number" step="0.1" value="{{ smax }}"></div>
    <div class="col-md-2"><label class="form-label">ポイント数</label><input name="points" class="form-control" type="number" step="1" value="{{ points }}"></div>

    <div class="col-12"><button class="btn btn-primary">描画</button></div>
  </form>

  <!-- サマリー -->
  <div class="card my-4">
    <div class="card-header fw-bold">サマリー</div>
    <div class="card-body">
      <div class="row g-3 text-center">

        <div class="col-md-4">
          <div class="border rounded p-3 h-100">
            <div class="small text-muted mb-1">Synthetic Fwd 値（C−P）</div>
            <div class="small">T1: {{ "{:.4f}".format(syn_T1) }} / T2: {{ "{:.4f}".format(syn_T2) }}（JPY/USD）</div>
            <div class="mt-2 small text-muted">※理論上ボラ非依存（パリティ）</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="border rounded p-3 h-100">
            <div class="small text-muted mb-1">金額（JPY）</div>
            <div class="fs-6">
              T1分：{{ "{:,.0f}".format(syn_T1_jpy) }} / T2分（ショート）：{{ "{:,.0f}".format(short_syn_T2_jpy) }}
            </div>
            <div class="small mt-1 text-muted">合成（フラット）＝ {{ "{:,.0f}".format(flat_pl) }} JPY</div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="border rounded p-3 h-100">
            <div class="small text-muted mb-1">パリティ差（検算）</div>
            <div class="fs-6">{{ "{:,.0f}".format(parity_diff_jpy) }} JPY</div>
            <div class="small mt-1 text-muted">= [DF_for·S0 − DF_dom·K]@T1 − 同@T2</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- 損益グラフ（水平） -->
  <div class="card mb-4">
    <div class="card-header fw-bold">損益グラフ（Jelly Roll）</div>
    <div class="card-body">
      <div class="row"><div class="col-12 col-lg-10 col-xl-9 mx-auto">
        <img class="img-fluid border rounded w-100" alt="jelly-roll-plot" src="data:image/png;base64,{{ png_b64 }}">
      </div></div>
    </div>
  </div>

  <!-- 損益分岐点（通常なし） -->
  <div class="card mb-4">
    <div class="card-header fw-bold">損益分岐点（Break-even）</div>
    <div class="card-body">
      <div class="row"><div class="col-12 col-lg-10 col-xl-9 mx-auto">
        <img class="img-fluid border rounded w-100" alt="jelly-roll-be" src="data:image/png;base64,{{ png_b64_be }}">
      </div></div>
    </div>
  </div>

  <!-- テーブル（水平値を0.25刻みで出力） -->
  <div class="table-responsive">
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>S_T (USD/JPY)</th>
          <th>SynFwd_T1 (JPY)</th>
          <th>Short_SynFwd_T2 (JPY)</th>
          <th>Combo_PnL (JPY)</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ "%.3f"|format(r.st) }}</td>
          <td>{{ "{:,.0f}".format(r.syn_T1) }}</td>
          <td>{{ "{:,.0f}".format(r.short_syn_T2) }}</td>
          <td>{{ "{:,.0f}".format(r.combo) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- CSV -->
  <form method="post" action="{{ url_for('fx_download_csv_jelly_roll') }}">
    <input type="hidden" name="K" value="{{ K }}">
    <input type="hidden" name="prem_c1" value="{{ prem_c1 }}"><input type="hidden" name="prem_p1" value="{{ prem_p1 }}">
    <input type="hidden" name="prem_c2" value="{{ prem_c2 }}"><input type="hidden" name="prem_p2" value="{{ prem_p2 }}">
    <input type="hidden" name="qty" value="{{ qty }}">
    <input type="hidden" name="smin" value="{{ smin }}"><input type="hidden" name="smax" value="{{ smax }}"><input type="hidden" name="points" value="{{ points }}">
    <button class="btn btn-outline-secondary btn-sm">CSVダウンロード</button>
  </form>

  <!-- 補足 -->
  <div class="card mb-4">
    <div class="card-header fw-bold">補足</div>
    <div class="card-body">
      <ul class="mb-0">
        <li><b>Jelly Roll</b> は同一行使 K の <b>時間差</b>パッケージ（Synthetic Fwd のカレンダースプレッド）。</li>
        <li>理論上、価値は <code>(C−P)@T1 − (C−P)@T2</code> で、<b>ボラ非依存・S非依存</b>（金利と満期の関数）。</li>
        <li>パリティ：<code>C−P = DF_for·S0 − DF_dom·K</code>。表示の検算値と一致します。</li>
      </ul>
    </div>
  </div>

</div>
{% endblock %}
