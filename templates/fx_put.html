{% extends "base.html" %}
{% block title %}Protective Put Visualizer{% endblock %}
{% block content %}
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">Parameters</div>
    <div class="card-body">
      <form method="post" action="{{ url_for('fx_put') }}" class="row g-3">
        <div class="col-6 col-md-2">
          <label class="form-label">S0 (USD/JPY)</label>
          <input type="number" step="0.01" class="form-control" name="S0" value="{{ '%.2f'|format(S0) if S0 is defined else '150.00' }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">K (Strike)</label>
          <input type="number" step="0.01" class="form-control" name="K" value="{{ '%.2f'|format(K) if K is defined else '145.00' }}">
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Premium (JPY/USD)</label>
          <input type="number" step="0.01" class="form-control" name="premium" value="{{ '%.2f'|format(premium) if premium is defined else '1.20' }}">
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Quantity (USD)</label>
          <input type="number" step="1" class="form-control" name="qty" value="{{ '%d'|format(qty) if qty is defined else '1000000' }}">
        </div>
        <div class="col-6 col-md-1">
          <label class="form-label">Min</label>
          <input type="number" step="0.1" class="form-control" name="smin" value="{{ '%.1f'|format(smin) if smin is defined else '120.0' }}">
        </div>
        <div class="col-6 col-md-1">
          <label class="form-label">Max</label>
          <input type="number" step="0.1" class="form-control" name="smax" value="{{ '%.1f'|format(smax) if smax is defined else '170.0' }}">
        </div>
        <div class="col-6 col-md-1">
          <label class="form-label">Points</label>
          <input type="number" step="1" class="form-control" name="points" value="{{ '%d'|format(points) if points is defined else '251' }}">
        </div>
        <div class="col-12">
          <button class="btn btn-primary">Update Chart</button>
          <a class="btn btn-outline-success ms-2" href="{{ url_for('fx_call') }}">→ Callページへ</a>
          <span class="ms-2 form-note">* グラフ内の文字は英語。日本語の解説は本ページで補足表示します。</span>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">損益グラフ (Protective Put: P/L vs Terminal USD/JPY)</div>
    <div class="card-body">
      {% if png_b64 %}
        <img class="img-fluid border" alt="P/L chart" src="data:image/png;base64,{{ png_b64 }}">
      {% else %}
        <div class="text-muted">グラフを表示するにはパラメータを送信してください。</div>
      {% endif %}
      <div class="mt-2 text-muted small">
        フロア（理論下限）：<span class="code">{{ '{:,.0f}'.format(floor) if floor is defined else '' }}</span> JPY
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">英語ラベルの日本語解説</div>
    <div class="card-body">
      <ul>
        <li><b>Spot USD P/L (vs today)</b> … ドル現物の損益（現在比）。</li>
        <li><b>Long Put P/L (incl. premium)</b> … プット買いの損益（プレミアム込み）。</li>
        <li><b>Protective Put Combo P/L</b> … ドル現物＋プットの合成損益。</li>
        <li><b>Breakeven</b> … 損益ゼロライン。</li>
        <li><b>S0</b> … 現在のドル円レート。</li>
        <li><b>K</b> … プットのストライク。</li>
        <li><b>Loss floor</b> … 最大損失。</li>
      </ul>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">計算データ一覧</span>
      <form method="post" action="{{ url_for('fx_download_csv_put') }}" class="m-0">
        <input type="hidden" name="S0" value="{{ S0 }}">
        <input type="hidden" name="K" value="{{ K }}">
        <input type="hidden" name="premium" value="{{ premium }}">
        <input type="hidden" name="qty" value="{{ qty }}">
        <input type="hidden" name="smin" value="{{ smin }}">
        <input type="hidden" name="smax" value="{{ smax }}">
        <input type="hidden" name="points" value="{{ points }}">
        <button class="btn btn-sm btn-outline-secondary">CSVダウンロード</button>
      </form>
    </div>
    <div class="card-body table-scroll p-0">
      <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>S_T (USD/JPY)</th>
            <th>Spot P/L (JPY)</th>
            <th>Put P/L (JPY)</th>
            <th>Combo P/L (JPY)</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>{{ '%.3f'|format(r.st) }}</td>
            <td class="text-end">{{ '{:,.0f}'.format(r.spot) }}</td>
            <td class="text-end">{{ '{:,.0f}'.format(r.put) }}</td>
            <td class="text-end">{{ '{:,.0f}'.format(r.combo) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}