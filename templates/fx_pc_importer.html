{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Participating Collar（輸入向け）</h2>

  <form method="post" class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="S0" class="form-label">Spot (S0)</label>
      <input type="number" step="0.01" class="form-control" name="S0" value="{{ S0 }}">
    </div>

    <div class="col-md-3">
      <label for="Kc" class="form-label">Call Strike (Kc)</label>
      <input type="number" step="0.01" class="form-control" name="Kc" value="{{ Kc }}">
    </div>

    <div class="col-md-3">
      <label for="Kp" class="form-label">Put Strike (Kp)</label>
      <input type="number" step="0.01" class="form-control" name="Kp" value="{{ Kp }}">
    </div>

    <div class="col-md-3">
      <label for="r" class="form-label">参加率 r (0〜1)</label>
      <input type="number" step="0.01" min="0" max="1" class="form-control" name="r" value="{{ r }}">
    </div>

    <div class="col-md-3">
      <label for="vol" class="form-label">Volatility (%)</label>
      <input type="number" step="0.1" class="form-control" name="vol" value="{{ vol }}">
    </div>

    <div class="col-md-3">
      <label for="r_dom" class="form-label">JPY Rate (%)</label>
      <input type="number" step="0.1" class="form-control" name="r_dom" value="{{ r_dom }}">
    </div>

    <div class="col-md-3">
      <label for="r_for" class="form-label">USD Rate (%)</label>
      <input type="number" step="0.1" class="form-control" name="r_for" value="{{ r_for }}">
    </div>

    <div class="col-md-3">
      <label for="months" class="form-label">Tenor (months)</label>
      <input type="number" step="0.1" class="form-control" name="months" value="{{ months }}">
    </div>

    <div class="col-md-3">
      <label for="qty" class="form-label">Notional (USD)</label>
      <input type="number" step="1000" class="form-control" name="qty" value="{{ qty }}">
    </div>

    <div class="col-md-3">
      <label for="smin" class="form-label">Min Rate</label>
      <input type="number" step="0.1" class="form-control" name="smin" value="{{ smin }}">
    </div>

    <div class="col-md-3">
      <label for="smax" class="form-label">Max Rate</label>
      <input type="number" step="0.1" class="form-control" name="smax" value="{{ smax }}">
    </div>

    <div class="col-md-3">
      <label for="points" class="form-label">Grid Points</label>
      <input type="number" step="1" class="form-control" name="points" value="{{ points }}">
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary">計算する</button>
      <button type="submit" formaction="{{ url_for('fx_download_csv_pc_importer') }}" class="btn btn-outline-secondary ms-2">
        CSVダウンロード
      </button>
    </div>
  </form>

  <!-- サマリー -->
  <div class="card my-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">サマリー</span>
      <a
        class="btn btn-sm btn-outline-primary"
        href="{{ url_for('static', filename='reports/participating_collar_importer_report.pdf') }}"
        target="_blank" rel="noopener"
      >デフォルト報告書</a>
    </div>
    <div class="card-body">
      <div class="row g-3 text-center">

        <!-- オプション純額 -->
        <div class="col-md-4">
          <div class="card h-100 p-3">
            <div class="fw-semibold mb-1">オプション純額（受取 − 支払）</div>
            <div class="fs-4 fw-bold text-primary">
              {{ "{:,.0f}".format(opt_net|default(0)) }} JPY
            </div>
            <div class="small text-muted mt-2">
              受取 (Put)：{{ "{:,.0f}".format(prem_put_jpy|default(0)) }} JPY<br>
              支払 (Call)：{{ "{:,.0f}".format(prem_call_jpy|default(0)) }} JPY<br>
              名目比（純額）：{{ "{:.2%}".format(opt_net_ratio|default(0)) }}<br>
              （Put Premium {{ "{:,.4f}".format(prem_put|default(0)) }} × {{ "{:,.0f}".format(qty|default(0)) }} USD /
               Call Premium {{ "{:,.4f}".format(prem_call|default(0)) }} × {{ "{:,.0f}".format(qty|default(0)) }} USD）
            </div>
          </div>
        </div>

        <!-- 借入利息 -->
        <div class="col-md-4">
          <div class="card h-100 p-3">
            <div class="fw-semibold mb-1">借入利息</div>
            <div class="fs-4 fw-bold text-danger">
              {{ "{:,.0f}".format(interest_jpy|default(0)) }} JPY
            </div>
            <div class="small text-muted mt-2">
              （年率 {{ "{:.2f}".format(r_for|default(0)) }}% × {{ "{:.1f}".format(months|default(0)) }}ヶ月 /
              元本：{{ "{:,.0f}".format(S0 * qty|default(0)) }} JPY）
            </div>
          </div>
        </div>

        <!-- レンジ内最小損益 -->
        <div class="col-md-4">
          <div class="card h-100 p-3">
            <div class="fw-semibold mb-1">レンジ内最小損益</div>
            <div class="fs-4 fw-bold text-danger">
              {{ "{:,.0f}".format(min_pnl|default(0)) }} JPY
            </div>
            <div class="small text-muted mt-2">
              at S_T = {{ "{:,.3f}".format(st_label|default(0)) }} (USD/JPY)<br>
              レンジ：{{ "{:,.1f}".format(smin|default(0)) }} 〜 {{ "{:,.1f}".format(smax|default(0)) }}
            </div>
          </div>
        </div>

      </div> <!-- /.row -->
    </div> <!-- /.card-body -->
  </div> <!-- /.card -->

  <!-- 英語ラベルの日本語解説（追加） -->
  <div class="card my-3">
    <div class="card-header">
      <span class="fw-bold">英語ラベルの日本語解説</span>
    </div>
    <div class="card-body">
      <ul class="mb-0">
        <li><span class="fw-semibold">Short USD P/L (Importer baseline)</span> … 現物USDショート（将来USD支払）の損益（本日時点比）。</li>
        <li><span class="fw-semibold">Long Call P/L</span> … コール買いの損益（支払プレミアム込み）。</li>
        <li><span class="fw-semibold">Short Put P/L</span> … プット売りの損益（受取プレミアム込み）。</li>
        <li><span class="fw-semibold">Combo (Short USD + Call - Put)</span> … 合成損益（USDショート＋コール買い＋プット売り）。</li>
        <li><span class="fw-semibold">Zero-Cost Combo P/L</span> … 上記「合成損益」の線（ヘッジ比較グラフ）。</li>
        <li><span class="fw-semibold">Borrow Cost (flat)</span> … 借入利息の一定ライン（フラット）。</li>
      </ul>
    </div>
  </div>

  <!-- 計算データ一覧 -->
  <div class="card my-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">計算データ一覧</span>
      <!-- CSVダウンロード -->
      <form method="post" action="{{ url_for('fx_download_csv_zero_cost_longcall') }}" class="mb-0">
        <input type="hidden" name="S0" value="{{ S0 }}">
        <input type="hidden" name="Kc" value="{{ Kc }}">
        <input type="hidden" name="Kp" value="{{ Kp }}">
        <input type="hidden" name="prem_call" value="{{ prem_call }}">
        <input type="hidden" name="prem_put" value="{{ prem_put }}">
        <input type="hidden" name="qty" value="{{ qty }}">
        <input type="hidden" name="smin" value="{{ smin }}">
        <input type="hidden" name="smax" value="{{ smax }}">
        <input type="hidden" name="points" value="{{ points }}">
        <button class="btn btn-outline-secondary btn-sm">CSVダウンロード</button>
      </form>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>S_T (USD/JPY)</th>
              <th class="text-end">Long Call PnL (JPY)</th>
              <th class="text-end">Short Put × r PnL (JPY)</th>
              <th class="text-end">Spot Short PnL (JPY)</th>
              <th class="text-end">Combo PnL (JPY)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            <tr>
              <td>{{ "{:,.2f}".format(row.st) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(row.long_call) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(row.short_put) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(row.spot) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(row.combo) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
