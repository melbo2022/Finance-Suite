{% extends "base.html" %}
{% block title %}為替ヘッジ比較ツール（PUT オプション vs 借入）{% endblock %}

{% block content %}
<div class="container">
 <h1 class="mb-3 d-flex align-items-center">
  <span>為替ヘッジ比較ツール <small class="text-muted">（PUT オプション vs 借入）</small></span>
</h1>

  <p class="text-secondary">
    パラメータを入力して、プットオプション購入とドル借入によるヘッジを比較します。
    金額表示は分かりやすさのためJPY換算（基準レート）です。
  </p>

  <!-- 入力フォーム -->
  <div class="card p-3 mb-4">
    <form method="post">
      <input type="hidden" name="use_dates" value="false">

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">ヘッジ元本（USD）</label>
          <input type="number" step="0.01" class="form-control" name="notional_usd" value="{{ params.notional_usd }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">ドル金利（年率, %）</label>
          <input type="number" step="0.0001" class="form-control" name="usd_rate_annual" value="{{ params.usd_rate_annual }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">円金利（年率, %）</label>
          <input type="number" step="0.0001" class="form-control" name="jpy_rate_annual" value="{{ params.jpy_rate_annual }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">基準レート（JPY/USD）</label>
          <input type="number" step="0.0001" class="form-control" name="spot_jpy_per_usd" value="{{ params.spot_jpy_per_usd }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">行使価格（JPY/USD）</label>
          <input type="number" step="0.0001" class="form-control" name="strike_jpy_per_usd" value="{{ params.strike_jpy_per_usd }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">期間（月）</label>
          <input type="number" step="0.01" class="form-control" name="months" value="{{ params.months }}">
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" type="submit">計算する</button>
      </div>
    </form>
  </div>

  {% if result %}
  <!-- コスト概要 -->
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card p-3">
        <h5>コスト概要</h5>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between align-items-center">
            借入コスト
            <span class="badge bg-light text-dark">USD {{ "{:,.2f}".format(result.borrow_cost_usd) }}</span>
            <span class="badge bg-secondary">JPY {{ "{:,.0f}".format(result.borrow_cost_jpy) }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- シナリオ比較 -->
  <div class="card p-3 mt-3">
    <h5>シナリオ比較（円安/円高）</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
       <thead>
        <tr>
          <th class="text-center">円変動（円/ドル, ＋＝円安 / −＝円高）</th>
          <th class="text-center">オプション損益（JPY）</th>
          <th class="text-center">Spot損益（JPY）</th>
          <th class="text-center">合計（オプション＋Spot, JPY）</th>
          <th class="text-center">借入損益（JPY）</th>
          <th class="text-center">差額（オプション＋Spot−借入）</th>
          <th class="text-center">有利</th>
        </tr>
       </thead>
       <tbody>
        {% for row in scenarios %}
        <tr>
          <td class="num">{{ "{:+.0f}".format(row.move) }}</td>
          <td class="num">{{ "{:,.0f}".format(row.option_pnl_jpy) }}</td>
          <td class="num">{{ "{:,.0f}".format(row.spot_pnl_jpy) }}</td>
          <td class="num">{{ "{:,.0f}".format(row.option_pnl_jpy + row.spot_pnl_jpy) }}</td>
          <td class="num">{{ "{:,.0f}".format(row.borrow_pnl_jpy) }}</td>
          <td class="num">{{ "{:,.0f}".format(row.diff_vs_borrow) }}</td>
          <td class="text-center">
            {% if row.better == "オプション" %}
            <span class="badge bg-success">オプション</span>
            {% elif row.better == "借入" %}
            <span class="badge bg-primary">借入</span>
            {% else %}
            <span class="badge bg-secondary">同等</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
       </tbody>
      </table>
    </div>
    <small class="text-muted d-block mt-2">
      ※「有利」判定は <u>オプション損益＋Spot損益</u> と 借入損益 の比較に基づきます。<br>
      ※「差額」列は（オプション＋Spot−借入）の金額を表示しています。
    </small>
  </div>

  <!-- 差額グラフ -->
  <div class="card p-3 mt-3">
    <h5 class="mb-3">差額の推移（オプション＋Spot − 借入）</h5>
    <div id="diff-chart-put" style="height:460px;"></div>
    <small class="text-muted">
      緑線＝表の「差額」列（オプション＋Spot − 借入）をプロット。0より上ならオプション有利、下なら借入有利。
    </small>
  </div>

  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script>
    const moves_put = {{ scenarios | map(attribute='move') | list | tojson }};
    const diffs_put = {{ scenarios | map(attribute='diff_vs_borrow') | list | tojson }};

    const tracePut = {
      x: moves_put,
      y: diffs_put,
      name: "差額（オプション＋Spot − 借入）",
      mode: "lines+markers",
      line: { width: 3, color: "green" }
    };

    const baselinePut = {
      x: moves_put,
      y: moves_put.map(()=>0),
      name: "基準(0)",
      line: { dash: "dash", color: "black" }
    };

    Plotly.newPlot("diff-chart-put", [tracePut, baselinePut], {
      xaxis: { title: "円変動 Δ（円/ドル, ＋＝円安 / −＝円高）" },
      yaxis: { title: "差額 (JPY)", zeroline: true, zerolinecolor: "#000" },
      margin: { l: 70, r: 20, t: 10, b: 60 },
      legend: { orientation: "h", x: 0, y: 1.15 }
    });
  </script>
  {% endif %}
</div>
{% endblock %}
