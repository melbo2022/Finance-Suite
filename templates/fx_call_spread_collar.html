{% extends "base.html" %}
{% block title %}Call-Spread Collar（輸入向け）{% endblock %}

{% block content %}
<div class="container py-3">
  <h3 class="mb-3">Call-Spread Collar（輸入向け：Long Call@K1 − Short Call@K2 − Short Put@K3）</h3>

  <!-- 入力フォーム -->
  <form method="post" class="row g-3">
    <div class="col-md-2"><label class="form-label">S0 (USD/JPY)</label><input name="S0" class="form-control" type="number" step="0.1" value="{{ S0 }}"></div>
    <div class="col-md-2"><label class="form-label">K1 (Long Call)</label><input name="K1" class="form-control" type="number" step="0.1" value="{{ K1 }}"></div>
    <div class="col-md-2"><label class="form-label">K2 (Short Call)</label><input name="K2" class="form-control" type="number" step="0.1" value="{{ K2 }}"></div>
    <div class="col-md-2"><label class="form-label">K3 (Short Put)</label><input name="K3" class="form-control" type="number" step="0.1" value="{{ K3 }}"></div>

    <div class="col-md-2"><label class="form-label">Vol (%/年)</label><input name="vol" class="form-control" type="number" step="0.1" value="{{ vol }}"></div>
    <div class="col-md-2"><label class="form-label">r_dom JPY (%/年)</label><input name="r_dom" class="form-control" type="number" step="0.1" value="{{ r_dom }}"></div>
    <div class="col-md-2"><label class="form-label">r_for USD (%/年)</label><input name="r_for" class="form-control" type="number" step="0.1" value="{{ r_for }}"></div>

    <div class="col-md-2"><label class="form-label">数量 (USD)</label><input name="qty" class="form-control" type="number" step="1" value="{{ qty }}"></div>
    <div class="col-md-2"><label class="form-label">満期 (月)</label><input name="months" class="form-control" type="number" step="0.1" value="{{ months }}"></div>

    <div class="col-md-2"><label class="form-label">S最小</label><input name="smin" class="form-control" type="number" step="0.1" value="{{ smin }}"></div>
    <div class="col-md-2"><label class="form-label">S最大</label><input name="smax" class="form-control" type="number" step="0.1" value="{{ smax }}"></div>
    <div class="col-md-2"><label class="form-label">ポイント数</label><input name="points" class="form-control" type="number" step="1" value="{{ points }}"></div>

    <div class="col-12"><button class="btn btn-primary">描画</button></div>
  </form>

  <!-- サマリー -->
  <div class="card my-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">サマリー</span>
      <a class="btn btn-sm btn-outline-primary"
         href="{{ url_for('static', filename='reports/call_spread_collar_importer_report.pdf') }}"
         target="_blank" rel="noopener">デフォルト報告書</a>
    </div>
    <div class="card-body">
      <div class="row g-3 text-center">
        <!-- プレミアム純額と内訳 -->
        <div class="col-md-4">
          <div class="border rounded p-3 h-100">
            <div class="small text-muted mb-1">オプション純額（受取 − 支払）</div>
            <div class="fs-3 fw-bold">{{ "{:,.0f}".format(premium_net_jpy) }} JPY</div>
            <div class="small mt-1 text-muted">
              受取：Call@K2 {{ "{:.4f}".format(prem_call2) }} + Put@K3 {{ "{:.4f}".format(prem_put3) }}<br>
              支払：Call@K1 {{ "{:.4f}".format(prem_call1) }}<br>
              名目比（純額）：{{ "{:.2f}".format((premium_net_jpy/(S0*qty)*100.0) if S0*qty>0 else 0) }}%
            </div>
          </div>
        </div>
        <!-- 損益分岐点 -->
        <div class="col-md-4">
          <div class="border rounded p-3 h-100">
            <div class="small text-muted mb-1">損益分岐点（USD/JPY）</div>
            <div class="fs-6 fw-bold">
              {% if be_list and be_list|length>0 %}
                {% for v in be_list %}BE{{ loop.index }} = {{ "{:.3f}".format(v) }}{% if not loop.last %} ／ {% endif %}{% endfor %}
              {% else %}なし（レンジ内で常に損益一定符号）{% endif %}
            </div>
            <div class="small mt-1 text-muted">※ Combo（SpotShort+CallSpread−Put）の0交差を線形補間で抽出</div>
          </div>
        </div>
        <!-- レンジ内損益 -->
        <div class="col-md-4">
          <div class="border rounded p-3 h-100">
            <div class="small text-muted mb-1">レンジ内損益</div>
            <div class="fs-6">
              最大 {{ "{:,.0f}".format(range_cap) }} JPY at {{ "{:.3f}".format(range_cap_st) }}<br>
              最小 {{ "{:,.0f}".format(range_floor) }} JPY at {{ "{:.3f}".format(range_floor_st) }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- グラフ①：損益 -->
  <div class="card mb-4">
    <div class="card-header fw-bold">損益グラフ（Call-Spread Collar：P/L vs Terminal USD/JPY）</div>
    <div class="card-body">
      <div class="row">
        <div class="col-12 col-lg-10 col-xl-9 mx-auto">
          <img class="img-fluid border rounded w-100" alt="csc-plot" src="data:image/png;base64,{{ png_b64 }}">
        </div>
      </div>
    </div>
  </div>

  <!-- グラフ②：比較 -->
  <div class="card mb-4">
    <div class="card-header fw-bold">ヘッジ比較（No Hedge vs Call-Spread Collar）</div>
    <div class="card-body">
      <div class="row">
        <div class="col-12 col-lg-10 col-xl-9 mx-auto">
          <img class="img-fluid border rounded w-100" alt="csc-compare" src="data:image/png;base64,{{ png_b64_compare }}">
        </div>
      </div>
    </div>
  </div>

  <!-- ▼▼ ここから挿入：英語ラベルの日本語解説 ▼▼ -->
  <div class="card my-3">
    <div class="card-header">
      <span class="fw-bold">英語ラベルの日本語解説</span>
    </div>
    <div class="card-body">
      <ul class="mb-0">
        <li><span class="fw-semibold">Short USD P/L (Importer baseline)</span> … 現物USDショート（将来USD支払）の損益（本日時点比）。</li>
        <li><span class="fw-semibold">Long Call K1 P/L</span> … 権利行使価格K1のコール買い損益（支払プレミアム込み）。</li>
        <li><span class="fw-semibold">Short Call K2 P/L</span> … 権利行使価格K2のコール売り損益（受取プレミアム込み）。</li>
        <li><span class="fw-semibold">Short Put K3 P/L</span> … 権利行使価格K3のプット売り損益（受取プレミアム込み）。</li>
        <li><span class="fw-semibold">Combo (Short USD + Long Call@K1 − Short Call@K2 − Short Put@K3)</span> … 合成損益。</li>
      </ul>
    </div>
  </div>
  <!-- ▲▲ 挿入ここまで ▲▲ -->

  <!-- 計算データ一覧 -->
  <div class="card my-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">計算データ一覧</span>
      <!-- CSVダウンロード -->
      <form method="post" action="{{ url_for('fx_download_csv_call_spread_collar') }}" class="mb-0">
        <input type="hidden" name="S0" value="{{ S0 }}">
        <input type="hidden" name="K1" value="{{ K1 }}">
        <input type="hidden" name="K2" value="{{ K2 }}">
        <input type="hidden" name="K3" value="{{ K3 }}">
        <input type="hidden" name="prem_call1" value="{{ prem_call1 }}">
        <input type="hidden" name="prem_call2" value="{{ prem_call2 }}">
        <input type="hidden" name="prem_put3"  value="{{ prem_put3 }}">
        <input type="hidden" name="qty" value="{{ qty }}">
        <input type="hidden" name="smin" value="{{ smin }}">
        <input type="hidden" name="smax" value="{{ smax }}">
        <input type="hidden" name="points" value="{{ points }}">
        <button class="btn btn-outline-secondary btn-sm">CSVダウンロード</button>
      </form>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>S_T (USD/JPY)</th>
              <th class="text-end">Spot Short PnL (JPY)</th>
              <th class="text-end">Long Call K1 PnL (JPY)</th>
              <th class="text-end">Short Call K2 PnL (JPY)</th>
              <th class="text-end">Short Put K3 PnL (JPY)</th>
              <th class="text-end">Combo PnL (JPY)</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              <td>{{ "%.3f"|format(r.st) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(r.spot_short) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(r.long_call) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(r.short_call) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(r.short_put) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(r.combo) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
