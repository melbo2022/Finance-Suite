{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>シーガル（輸入向け：-Spot + Long Call + Short Put(Kp1) + Long Put(Kp2)）</h2>

  <form method="post" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">S0 (USD/JPY)</label>
      <input type="number" step="0.01" class="form-control" name="S0" value="{{ S0 }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Kp2 (Long Put)</label>
      <input type="number" step="0.01" class="form-control" name="Kp2" value="{{ Kp2 }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Kp1 (Short Put)</label>
      <input type="number" step="0.01" class="form-control" name="Kp1" value="{{ Kp1 }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Kc (Long Call)</label>
      <input type="number" step="0.01" class="form-control" name="Kc" value="{{ Kc }}">
    </div>

    <div class="col-md-3">
      <label class="form-label">Vol (%/年)</label>
      <input type="number" step="0.1" class="form-control" name="vol" value="{{ vol }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">r_dom JPY (%/年)</label>
      <input type="number" step="0.1" class="form-control" name="r_dom" value="{{ r_dom }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">r_for USD (%/年)</label>
      <input type="number" step="0.1" class="form-control" name="r_for" value="{{ r_for }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">満期 (月)</label>
      <input type="number" step="0.1" class="form-control" name="months" value="{{ months }}">
    </div>

    <div class="col-md-3">
      <label class="form-label">数量 (USD)</label>
      <input type="number" step="1000" class="form-control" name="qty" value="{{ qty }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">S最小</label>
      <input type="number" step="0.1" class="form-control" name="smin" value="{{ smin }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">S最大</label>
      <input type="number" step="0.1" class="form-control" name="smax" value="{{ smax }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">ポイント数</label>
      <input type="number" step="1" class="form-control" name="points" value="{{ points }}">
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary">計算する</button>
      <button type="submit" formaction="{{ url_for('fx_download_csv_seagull_importer') }}"
              class="btn btn-outline-secondary ms-2">
        CSVダウンロード
      </button>
    </div>
  </form>

  <!-- サマリー（1枚のカード） -->
  <div class="card my-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">サマリー</span>
      <a class="btn btn-sm btn-outline-primary"
         href="{{ url_for('static', filename='reports/seagull_importer_report.pdf') }}"
         target="_blank" rel="noopener">デフォルト報告書</a>
    </div>

    <div class="card-body">
      <div class="row g-3">
        <!-- 左：プレミアム -->
        <div class="col-md-6">
          <div class="border rounded p-3 h-100">
            <h6 class="mb-3">プレミアム</h6>

            <p class="mb-1">
              Long Call (Kc):
              {{ "{:,.6f}".format(prem_call|default(0)) }} USD
              ({{ "{:,.0f}".format(prem_call_jpy|default(0)) }} JPY)
            </p>
            <p class="mb-1">
              Short Put (Kp1):
              {{ "{:,.6f}".format(prem_put_sp|default(0)) }} USD 受取
              ({{ "{:,.0f}".format(prem_put_sp_jpy|default(0)) }} JPY)
            </p>
            <p class="mb-3">
              Long Put (Kp2):
              {{ "{:,.6f}".format(prem_put_lp|default(0)) }} USD
              ({{ "{:,.0f}".format(prem_put_lp_jpy|default(0)) }} JPY)
            </p>

            <hr class="my-2">
            <p class="mb-0 fw-semibold">
              Net Premium:
              {{ "{:,.6f}".format(premium_net|default(0)) }} USD
              ({{ "{:,.0f}".format(premium_net_jpy|default(0)) }} JPY)
            </p>
          </div>
        </div>

        <!-- 右：Break-even -->
        <div class="col-md-6">
          <div class="border rounded p-3 h-100">
            <h6 class="mb-3">Break-even</h6>
            <p class="mb-1">Lower: {{ "{:,.2f}".format(be_low  or 0) }}</p>
            <p class="mb-0">Upper: {{ "{:,.2f}".format(be_high or 0) }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  

  <!-- グラフ -->
  <div class="row mt-4">
    <div class="col-12">
      <h5>損益グラフ</h5>
      <img src="data:image/png;base64,{{ png_b64 }}" class="img-fluid" alt="P/L chart">
    </div>
  </div>
  <div class="row mt-4">
    <div class="col-12">
      <h5>損益分岐点グラフ</h5>
      <img src="data:image/png;base64,{{ png_b64_be }}" class="img-fluid" alt="Break-even chart">
    </div>
  </div>

  <!-- 英語ラベルの日本語解説 -->
  <div class="card my-3">
    <div class="card-header">
      <span class="fw-bold">英語ラベルの日本語解説</span>
    </div>
    <div class="card-body">
      <ul class="mb-0">
        <li><span class="fw-semibold">Short USD P/L (Importer baseline)</span> … 現物USDショート（将来USD支払）の損益（本日時点比）。</li>
        <li><span class="fw-semibold">Long Call(Kc) P/L</span> … コール買い(Kc)の損益（支払プレミアム込み）。</li>
        <li><span class="fw-semibold">Short Put(Kp1) P/L</span> … プット売り(Kp1)の損益（受取プレミアム込み）。</li>
        <li><span class="fw-semibold">Long Put(Kp2) P/L</span> … プット買い(Kp2)の損益（支払プレミアム込み）。</li>
        <li><span class="fw-semibold">Combo (Short USD + Call(Kc) - Put(Kp1) + Put(Kp2))</span> … 合成損益。</li>
      </ul>
    </div>
  </div>

  <!-- 計算データ一覧（表＋右上CSV） -->
  <div class="card my-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">計算データ一覧</span>
      <!-- CSVダウンロード -->
      <form method="post" action="{{ url_for('fx_download_csv_seagull_importer') }}" class="mb-0">
        <input type="hidden" name="S0" value="{{ S0 }}">
        <input type="hidden" name="Kp1" value="{{ Kp1 }}">
        <input type="hidden" name="Kp2" value="{{ Kp2 }}">
        <input type="hidden" name="Kc" value="{{ Kc }}">
        <input type="hidden" name="prem_call" value="{{ prem_call }}">
        <input type="hidden" name="prem_put_sp" value="{{ prem_put_sp }}">
        <input type="hidden" name="prem_put_lp" value="{{ prem_put_lp }}">
        <input type="hidden" name="qty" value="{{ qty }}">
        <input type="hidden" name="smin" value="{{ smin }}">
        <input type="hidden" name="smax" value="{{ smax }}">
        <input type="hidden" name="points" value="{{ points }}">
        <button class="btn btn-outline-secondary btn-sm">CSVダウンロード</button>
      </form>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead>
            <tr>
              <th>S_T (USD/JPY)</th>
              <th class="text-end">Short USD PnL (JPY)</th>
              <th class="text-end">Long Call(Kc) PnL (JPY)</th>
              <th class="text-end">Short Put(Kp1) PnL (JPY)</th>
              <th class="text-end">Long Put(Kp2) PnL (JPY)</th>
              <th class="text-end">Combo PnL (JPY)</th>
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
            <tr>
              <td>{{ "{:,.2f}".format(row.st) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(row.spot) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(row.long_call) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(row.short_put) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(row.long_put2) }}</td>
              <td class="text-end">{{ "{:,.0f}".format(row.combo) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
