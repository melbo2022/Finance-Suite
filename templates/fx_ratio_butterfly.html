{% extends "base.html" %}
{% block title %}Ratio Butterfly{% endblock %}

{% block content %}
<div class="container py-3">
  <h3 class="mb-3">Ratio Butterfly（Long K1 ×m1 / Short K2 ×m2 / Long K3 ×m3）</h3>

  <!-- 入力 -->
  <form method="post" class="row g-3">
    <div class="col-md-2">
      <label class="form-label">タイプ</label>
      <select name="opt_type" class="form-select">
        <option value="call" {{ "selected" if opt_type=="call" else "" }}>Call</option>
        <option value="put"  {{ "selected" if opt_type=="put"  else "" }}>Put</option>
      </select>
    </div>
    <div class="col-md-2"><label class="form-label">S0</label><input name="S0" class="form-control" type="number" step="0.1" value="{{ S0 }}"></div>

    <div class="col-md-2"><label class="form-label">K1 (Long)</label><input name="K1" class="form-control" type="number" step="0.1" value="{{ K1 }}"></div>
    <div class="col-md-2"><label class="form-label">K2 (Short)</label><input name="K2" class="form-control" type="number" step="0.1" value="{{ K2 }}"></div>
    <div class="col-md-2"><label class="form-label">K3 (Long)</label><input name="K3" class="form-control" type="number" step="0.1" value="{{ K3 }}"></div>

    <div class="col-md-2"><label class="form-label">m1</label><input name="m1" class="form-control" type="number" step="1" value="{{ m1 }}"></div>
    <div class="col-md-2"><label class="form-label">m2</label><input name="m2" class="form-control" type="number" step="1" value="{{ m2 }}"></div>
    <div class="col-md-2"><label class="form-label">m3</label><input name="m3" class="form-control" type="number" step="1" value="{{ m3 }}"></div>

    <div class="col-md-2"><label class="form-label">Vol (%/年)</label><input name="vol" class="form-control" type="number" step="0.1" value="{{ vol }}"></div>
    <div class="col-md-2"><label class="form-label">r_dom (%/年)</label><input name="r_dom" class="form-control" type="number" step="0.1" value="{{ r_dom }}"></div>
    <div class="col-md-2"><label class="form-label">r_for (%/年)</label><input name="r_for" class="form-control" type="number" step="0.1" value="{{ r_for }}"></div>

    <div class="col-md-2"><label class="form-label">数量 (USD)</label><input name="qty" class="form-control" type="number" step="1" value="{{ qty }}"></div>
    <div class="col-md-2"><label class="form-label">満期 (月)</label><input name="months" class="form-control" type="number" step="0.1" value="{{ months }}"></div>

    <div class="col-md-2"><label class="form-label">S最小</label><input name="smin" class="form-control" type="number" step="0.1" value="{{ smin }}"></div>
    <div class="col-md-2"><label class="form-label">S最大</label><input name="smax" class="form-control" type="number" step="0.1" value="{{ smax }}"></div>
    <div class="col-md-2"><label class="form-label">ポイント数</label><input name="points" class="form-control" type="number" step="1" value="{{ points }}"></div>

    <div class="col-12"><button class="btn btn-primary">描画</button></div>
  </form>

  <!-- サマリー -->
  <div class="card my-4">
    <div class="card-header fw-bold">サマリー</div>
    <div class="card-body">
      <div class="row g-3 text-center">
        <div class="col-md-4">
          <div class="border rounded p-3 h-100">
            <div class="small text-muted mb-1">初期純額</div>
            <div class="fs-3 fw-bold">{{ "{:,.0f}".format(premium_net_jpy) }} JPY</div>
            <div class="small text-muted">( {{ "{:.4f}".format(premium_net_per_usd) }} JPY/USD )</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="border rounded p-3 h-100">
            <div class="small text-muted mb-1">損益分岐点</div>
            <div class="fs-6">
              {% if be_vals|length == 0 %}—{% else %}
                {{ be_vals|map('float')|map('round', 3)|list|join(' / ') }}
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="border rounded p-3 h-100">
            <div class="small text-muted mb-1">レンジ内損益（参考）</div>
            <div class="fs-6">
              最大 {{ "{:,.0f}".format(range_cap) }} JPY @ {{ "{:.3f}".format(range_cap_st) }}<br>
              最小 {{ "{:,.0f}".format(range_floor) }} JPY @ {{ "{:.3f}".format(range_floor_st) }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 損益グラフ -->
  <div class="card mb-4">
    <div class="card-header fw-bold">損益グラフ（Ratio Butterfly）</div>
    <div class="card-body">
      <div class="row"><div class="col-12 col-lg-10 col-xl-9 mx-auto">
        <img class="img-fluid border rounded w-100" alt="ratio-bfly-plot" src="data:image/png;base64,{{ png_b64 }}">
      </div></div>
    </div>
  </div>

  <!-- 損益分岐点 -->
  <div class="card mb-4">
    <div class="card-header fw-bold">損益分岐点（Break-even）</div>
    <div class="card-body">
      <div class="row"><div class="col-12 col-lg-10 col-xl-9 mx-auto">
        <img class="img-fluid border rounded w-100" alt="ratio-bfly-be" src="data:image/png;base64,{{ png_b64_be }}">
      </div></div>
    </div>
  </div>

  <!-- テーブル -->
  <div class="table-responsive">
    <table class="table table-sm table-striped">
      <thead><tr><th>S_T</th><th>Leg1_PnL</th><th>Leg2_PnL</th><th>Leg3_PnL</th><th>Combo_PnL</th></tr></thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ "%.3f"|format(r.st) }}</td>
          <td>{{ "{:,.0f}".format(r.leg1) }}</td>
          <td>{{ "{:,.0f}".format(r.leg2) }}</td>
          <td>{{ "{:,.0f}".format(r.leg3) }}</td>
          <td>{{ "{:,.0f}".format(r.combo) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- CSV -->
  <form method="post" action="{{ url_for('fx_download_csv_ratio_butterfly') }}">
    <input type="hidden" name="opt_type" value="{{ opt_type }}">
    <input type="hidden" name="K1" value="{{ K1 }}"><input type="hidden" name="K2" value="{{ K2 }}"><input type="hidden" name="K3" value="{{ K3 }}">
    <input type="hidden" name="prem1" value="{{ prem1 }}"><input type="hidden" name="prem2" value="{{ prem2 }}"><input type="hidden" name="prem3" value="{{ prem3 }}">
    <input type="hidden" name="m1" value="{{ m1 }}"><input type="hidden" name="m2" value="{{ m2 }}"><input type="hidden" name="m3" value="{{ m3 }}">
    <input type="hidden" name="qty" value="{{ qty }}"><input type="hidden" name="smin" value="{{ smin }}"><input type="hidden" name="smax" value="{{ smax }}"><input type="hidden" name="points" value="{{ points }}">
    <button class="btn btn-outline-secondary btn-sm">CSVダウンロード</button>
  </form>
</div>
{% endblock %}
